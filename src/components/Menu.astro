---
import { getCollection, type CollectionEntry } from "astro:content";
import { siteLang, siteCurrency } from "../data/config";
import type { Plate, PlateItem } from "../types";

const plates: Plate[] = await getCollection("plates");
const siteLangFormat = siteLang.replace("_", "-");
---

<!-- Quick Nav -->
<div id="plate-nav-wrapper" class="mb-12 lg:mb-16 sticky top-16 z-30">
  <nav class="menu-nav bg-secondary border border-border rounded-lg max-w-4xl mx-auto shadow-card">
    <div class="swiper-plates w-auto overflow-hidden">
      <ul id="plate-nav" class="px-2 py-2 swiper-wrapper">
        {
          plates.map((plate: Plate, index: number) => (
            <li class="swiper-slide w-auto! last:mr-4">
              <a
                href={`#${plate.data.slug}`}
                class:list={[
                  "menu-nav-link block rounded-lg px-4 py-2 transition-all duration-200 font-medium select-none",
                  index === 0 ? "menu-nav-active" : "text-secondary hover:text-primary hover:bg-tertiary"
                ]}
                data-category-link={plate.data.slug}
              >
                {plate.data.prettyName}
              </a>
            </li>
          ))
        }
      </ul>
    </div>
  </nav>
</div>

<div class="grid grid-cols-1 gap-y-20 lg:gap-y-24">
  {
    plates.map((plate: Plate) => (
      <div
        id={plate.data.slug}
        class="space-y-8 scroll-mt-28"
        data-category-section={plate.data.slug}
      >
        <div class="flex flex-col items-center gap-2 max-w-lg mx-auto text-balance text-center">
          <h3 class="text-2xl md:text-3xl font-bold text-primary">{plate.data.prettyName}</h3>
          <p class="text-secondary">{plate.data.description}</p>
        </div>

        <dl class="max-w-4xl mx-auto">
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 lg:gap-6">
            {plate.data.plates.map((item: PlateItem) => (
              <div class="group p-4 rounded-lg border border-border bg-secondary transition-all hover:shadow-card">
                <dt>
                  <div class="flex justify-between items-baseline gap-4">
                    <span class="font-semibold text-lg text-primary">
                      {item.name}
                    </span>
                    <span class="font-bold text-lg text-accent shrink-0">
                      {new Intl.NumberFormat(siteLangFormat, {
                        style: "currency",
                        currency: siteCurrency,
                      }).format(item.price)}
                    </span>
                  </div>
                </dt>
                <dd>
                  <p class="mt-1 text-muted text-sm leading-relaxed">
                    {item.description}
                  </p>
                </dd>
              </div>
            ))}
          </div>
        </dl>
      </div>
    ))
  }
</div>

<style>
  @media screen and (max-width: 640px) {
    #plate-nav-wrapper {
      margin-left: -1.5rem;
      margin-right: -1.5rem;
      max-width: calc(100% + 3rem);
    }
    .menu-nav {
      border-radius: 0;
      border-left: 0;
      border-right: 0;
    }
  }
  
  .menu-nav-active {
    background-color: var(--color-accent);
    color: var(--color-surface-950);
  }
  .menu-nav-active:hover {
    background-color: var(--color-accent-hover);
    color: var(--color-surface-950);
  }
</style>

<script>
  import Swiper from "swiper";
  import "swiper/css";

  function initMenuSwiper() {
    const swiperEl = document.querySelector(".swiper-plates") as HTMLElement;
    if (!swiperEl) return;

    const swiper = new Swiper(swiperEl, {
      loop: false,
      spaceBetween: 8,
      slidesPerView: "auto",
      freeMode: true,
    });

    const categoryLinks = document.querySelectorAll("[data-category-link]");
    const categorySections = document.querySelectorAll("[data-category-section]");
    let isNavigatingByClick = false;

    function setActiveCategory(id: string) {
      categoryLinks.forEach((link) => {
        link.classList.remove("menu-nav-active");
        link.classList.add("text-secondary", "hover:text-primary", "hover:bg-tertiary");
      });

      const currentLink = document.querySelector(`[data-category-link="${id}"]`);
      if (currentLink) {
        currentLink.classList.add("menu-nav-active");
        currentLink.classList.remove("text-secondary", "hover:text-primary", "hover:bg-tertiary");
        
        const linkIndex = Array.from(categoryLinks).indexOf(currentLink);
        if (linkIndex !== -1) {
          swiper.slideTo(Math.max(0, linkIndex - 1));
        }
      }
    }

    categoryLinks.forEach((link) => {
      link.addEventListener("click", () => {
        const targetId = (link as HTMLElement).dataset.categoryLink;
        if (targetId) {
          isNavigatingByClick = true;
          setActiveCategory(targetId);
          setTimeout(() => { isNavigatingByClick = false; }, 800);
        }
      });
    });

    const observer = new IntersectionObserver(
      (entries) => {
        if (isNavigatingByClick) return;
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            const sectionId = (entry.target as HTMLElement).dataset.categorySection;
            if (sectionId) setActiveCategory(sectionId);
          }
        });
      },
      { rootMargin: "-25% 0px -55% 0px", threshold: 0 }
    );

    categorySections.forEach((section) => observer.observe(section));

    // Set initial
    if (window.location.hash) {
      setActiveCategory(window.location.hash.substring(1));
    } else if (categorySections.length > 0) {
      const firstId = (categorySections[0] as HTMLElement).dataset.categorySection;
      if (firstId) setActiveCategory(firstId);
    }
  }

  // Initialize on page load and on Astro navigation
  document.addEventListener("astro:page-load", initMenuSwiper);
  if (document.readyState === "complete") {
    initMenuSwiper();
  }
</script>
