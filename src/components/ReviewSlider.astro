---
import { getCollection } from "astro:content";
import { Icon } from "astro-icon/components";
import type { Review } from "../types";
const allReviews: Review[] = await getCollection("reviews");
---

<section class="testimonials" aria-labelledby="testimonials-heading">
  <h2 id="testimonials-heading" class="sr-only">Customer Testimonials</h2>
  
  <div class="testimonials-track" data-testimonials>
    <div class="testimonials-slider">
      {
        allReviews.map((review, index) => (
          <article 
            class="testimonial-card" 
            data-testimonial={index}
            aria-label={`Review by ${review.data.author}`}
          >
            <div class="testimonial-content">
              <!-- Quote Icon -->
              <div class="testimonial-quote-icon" aria-hidden="true">
                <Icon name="lucide:quote" class="size-8" />
              </div>
              
              <!-- Rating -->
              <div class="testimonial-rating" role="img" aria-label="5 out of 5 stars">
                {[...Array(5)].map((_, i) => (
                  <Icon name="lucide:star" class="testimonial-star" aria-hidden="true" />
                ))}
              </div>
              
              <!-- Review Text -->
              <blockquote class="testimonial-text">
                <p>{review.data.review}</p>
              </blockquote>
              
              <!-- Author -->
              <footer class="testimonial-author">
                <div class="testimonial-avatar" aria-hidden="true">
                  {review.data.author.charAt(0).toUpperCase()}
                </div>
                <div class="testimonial-meta">
                  <cite class="testimonial-name">{review.data.author}</cite>
                  <span class="testimonial-badge">Verified Customer</span>
                </div>
              </footer>
            </div>
          </article>
        ))
      }
    </div>
  </div>
  
  <!-- Navigation -->
  <div class="testimonials-nav">
    <button 
      type="button" 
      class="testimonial-nav-btn" 
      data-prev
      aria-label="Previous testimonial"
    >
      <Icon name="lucide:chevron-left" class="size-5" />
    </button>
    
    <div class="testimonials-dots" role="tablist" aria-label="Testimonial navigation">
      {allReviews.map((_, index) => (
        <button
          type="button"
          class="testimonial-dot"
          data-dot={index}
          role="tab"
          aria-selected={index === 0 ? "true" : "false"}
          aria-label={`Go to testimonial ${index + 1}`}
        />
      ))}
    </div>
    
    <button 
      type="button" 
      class="testimonial-nav-btn" 
      data-next
      aria-label="Next testimonial"
    >
      <Icon name="lucide:chevron-right" class="size-5" />
    </button>
  </div>
</section>

<style>
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }
  
  .testimonials {
    width: 100%;
    max-width: 100%;
    overflow: hidden;
  }
  
  .testimonials-track {
    width: 100%;
    overflow: hidden;
    position: relative;
  }
  
  .testimonials-slider {
    display: flex;
    transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    will-change: transform;
  }
  
  .testimonial-card {
    flex: 0 0 100%;
    min-width: 0;
    padding: 0 1rem;
    box-sizing: border-box;
  }
  
  .testimonial-content {
    background: linear-gradient(
      135deg,
      var(--color-bg-elevated) 0%,
      var(--color-bg-secondary) 100%
    );
    border: 1px solid var(--color-border);
    border-radius: 1.5rem;
    padding: 2rem;
    text-align: center;
    position: relative;
    box-shadow: var(--shadow-md);
    max-width: 40rem;
    margin: 0 auto;
  }
  
  @media (min-width: 768px) {
    .testimonial-content {
      padding: 2.5rem 3rem;
    }
  }
  
  .testimonial-quote-icon {
    position: absolute;
    top: -0.75rem;
    left: 50%;
    transform: translateX(-50%);
    width: 2.5rem;
    height: 2.5rem;
    background-color: var(--color-cta);
    color: #ffffff;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: var(--shadow-sm);
  }
  
  .testimonial-quote-icon [data-icon] {
    width: 1.25rem;
    height: 1.25rem;
  }
  
  .testimonial-rating {
    display: flex;
    justify-content: center;
    gap: 0.25rem;
    margin-top: 1rem;
    margin-bottom: 1.5rem;
  }
  
  .testimonial-star {
    width: 1.25rem;
    height: 1.25rem;
    color: #f59e0b;
    fill: #f59e0b;
  }
  
  .testimonial-text {
    border: none;
    padding: 0;
    margin: 0 0 1.5rem;
  }
  
  .testimonial-text p {
    font-size: 1.125rem;
    line-height: 1.8;
    color: var(--color-text-primary);
    font-weight: 500;
    font-style: italic;
    margin: 0;
  }
  
  @media (min-width: 768px) {
    .testimonial-text p {
      font-size: 1.25rem;
    }
  }
  
  .testimonial-author {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--color-border);
  }
  
  .testimonial-avatar {
    width: 3rem;
    height: 3rem;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--color-accent) 0%, var(--color-accent-hover) 100%);
    color: #ffffff;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 1.25rem;
    flex-shrink: 0;
    box-shadow: var(--shadow-sm);
  }
  
  .testimonial-meta {
    display: flex;
    flex-direction: column;
    text-align: left;
  }
  
  .testimonial-name {
    font-style: normal;
    font-weight: 700;
    color: var(--color-text-primary);
    font-size: 1rem;
  }
  
  .testimonial-badge {
    font-size: 0.75rem;
    color: var(--color-accent);
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }
  
  /* Navigation */
  .testimonials-nav {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    margin-top: 2rem;
  }
  
  .testimonial-nav-btn {
    width: 2.5rem;
    height: 2.5rem;
    border-radius: 50%;
    border: 2px solid var(--color-border);
    background-color: var(--color-bg-elevated);
    color: var(--color-text-secondary);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  .testimonial-nav-btn:hover {
    border-color: var(--color-accent);
    color: var(--color-accent);
    background-color: var(--color-accent-bg);
  }
  
  .testimonial-nav-btn:focus-visible {
    outline: 2px solid var(--color-accent);
    outline-offset: 2px;
  }
  
  .testimonials-dots {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  
  .testimonial-dot {
    width: 0.625rem;
    height: 0.625rem;
    border-radius: 50%;
    border: none;
    background-color: var(--color-border-strong);
    cursor: pointer;
    transition: all 0.3s ease;
    padding: 0;
  }
  
  .testimonial-dot:hover {
    background-color: var(--color-text-muted);
    transform: scale(1.2);
  }
  
  .testimonial-dot[aria-selected="true"] {
    background-color: var(--color-cta);
    width: 1.5rem;
    border-radius: 0.5rem;
  }
  
  .testimonial-dot:focus-visible {
    outline: 2px solid var(--color-accent);
    outline-offset: 2px;
  }
</style>

<script>
  // Testimonials slider with proper cleanup for View Transitions
  (function() {
    let controller: AbortController | null = null;
    let autoplayInterval: ReturnType<typeof setInterval> | null = null;
    
    function cleanup() {
      if (controller) {
        controller.abort();
        controller = null;
      }
      if (autoplayInterval) {
        clearInterval(autoplayInterval);
        autoplayInterval = null;
      }
    }
    
    function initTestimonials() {
      cleanup();
      
      const container = document.querySelector('[data-testimonials]');
      if (!container) return;
      
      controller = new AbortController();
      const signal = controller.signal;
      
      const slider = container.querySelector('.testimonials-slider') as HTMLElement;
      const cards = container.querySelectorAll('.testimonial-card');
      const dots = document.querySelectorAll('.testimonial-dot');
      const prevBtn = document.querySelector('[data-prev]');
      const nextBtn = document.querySelector('[data-next]');
      
      if (!slider || cards.length === 0) return;
      
      let currentIndex = 0;
      const totalSlides = cards.length;
      
      // Reset slider position on init
      slider.style.transform = 'translateX(0)';
      
      function goToSlide(index: number) {
        if (index < 0) index = totalSlides - 1;
        if (index >= totalSlides) index = 0;
        
        currentIndex = index;
        slider.style.transform = `translateX(-${currentIndex * 100}%)`;
        
        dots.forEach((dot, i) => {
          dot.setAttribute('aria-selected', i === currentIndex ? 'true' : 'false');
        });
      }
      
      function nextSlide() {
        goToSlide(currentIndex + 1);
      }
      
      function prevSlide() {
        goToSlide(currentIndex - 1);
      }
      
      function startAutoplay() {
        if (autoplayInterval) {
          clearInterval(autoplayInterval);
        }
        autoplayInterval = setInterval(nextSlide, 5000);
      }
      
      function stopAutoplay() {
        if (autoplayInterval) {
          clearInterval(autoplayInterval);
          autoplayInterval = null;
        }
      }
      
      // Event listeners with abort signal
      prevBtn?.addEventListener('click', () => {
        prevSlide();
        startAutoplay();
      }, { signal });
      
      nextBtn?.addEventListener('click', () => {
        nextSlide();
        startAutoplay();
      }, { signal });
      
      dots.forEach((dot, index) => {
        dot.addEventListener('click', () => {
          goToSlide(index);
          startAutoplay();
        }, { signal });
      });
      
      container.addEventListener('mouseenter', stopAutoplay, { signal });
      container.addEventListener('mouseleave', startAutoplay, { signal });
      
      // Touch/swipe support
      let touchStartX = 0;
      
      container.addEventListener('touchstart', (e) => {
        touchStartX = (e as TouchEvent).changedTouches[0].screenX;
      }, { passive: true, signal });
      
      container.addEventListener('touchend', (e) => {
        const touchEndX = (e as TouchEvent).changedTouches[0].screenX;
        const diff = touchStartX - touchEndX;
        
        if (Math.abs(diff) > 50) {
          if (diff > 0) {
            nextSlide();
          } else {
            prevSlide();
          }
          startAutoplay();
        }
      }, { passive: true, signal });
      
      // Keyboard navigation (scoped to when container is focused)
      (container as HTMLElement).addEventListener('keydown', function(e) {
        if ((e as KeyboardEvent).key === 'ArrowLeft') {
          prevSlide();
          startAutoplay();
        } else if ((e as KeyboardEvent).key === 'ArrowRight') {
          nextSlide();
          startAutoplay();
        }
      }, { signal });
      
      // Start autoplay
      startAutoplay();
    }
    
    // Cleanup before page swap
    document.addEventListener('astro:before-swap', cleanup);
    
    // Initialize on page load
    document.addEventListener('astro:page-load', initTestimonials);
  })();
</script>
