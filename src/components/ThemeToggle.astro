---
import { Icon } from "astro-icon/components";
---

<div x-data="themeToggle()" x-init="init()">
	<button
		@click="toggle()"
		type="button"
		class="theme-toggle"
		:aria-label="isDark ? 'Switch to light mode' : 'Switch to dark mode'"
		:title="isDark ? 'Switch to light mode' : 'Switch to dark mode'"
	>
		<span x-show="!isDark" x-cloak>
			<Icon name="lucide:moon" class="size-5" aria-hidden="true" />
		</span>
		<span x-show="isDark" x-cloak>
			<Icon name="lucide:sun" class="size-5" aria-hidden="true" />
		</span>
	</button>
</div>

<style>
	.theme-toggle {
		display: flex;
		align-items: center;
		justify-content: center;
		padding: 0.625rem;
		border-radius: 0.5rem;
		background-color: transparent;
		border: none;
		color: var(--color-text-secondary);
		cursor: pointer;
		transition: all 0.2s ease;
	}
	
	.theme-toggle:hover {
		background-color: var(--color-bg-tertiary);
		color: var(--color-text-primary);
	}
	
	.theme-toggle:focus {
		outline: none;
	}
	
	.theme-toggle:focus-visible {
		outline: 2px solid var(--color-accent);
		outline-offset: 2px;
	}
</style>

<script>
	// Register Alpine component once
	function registerThemeToggle() {
		// @ts-ignore
		if (window.Alpine && !window.Alpine.data._x_registeredThemeToggle) {
			// @ts-ignore
			window.Alpine.data("themeToggle", () => ({
				isDark: false,

				init() {
					const stored = localStorage.getItem("theme");
					if (stored) {
						this.isDark = stored === "dark";
					} else {
						this.isDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
					}
					this.applyTheme();

					window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", (e) => {
						if (!localStorage.getItem("theme")) {
							this.isDark = e.matches;
							this.applyTheme();
						}
					});
				},

				toggle() {
					this.isDark = !this.isDark;
					localStorage.setItem("theme", this.isDark ? "dark" : "light");
					this.applyTheme();
				},

				applyTheme() {
					document.documentElement.classList.toggle("dark", this.isDark);
				},
			}));
			// @ts-ignore
			window.Alpine.data._x_registeredThemeToggle = true;
		}
	}

	// Register on Alpine init
	document.addEventListener("alpine:init", registerThemeToggle);
	
	// Re-initialize Alpine components after View Transitions
	document.addEventListener("astro:page-load", () => {
		// @ts-ignore
		if (window.Alpine) {
			registerThemeToggle();
			// Reinitialize all Alpine components on the page
			// @ts-ignore
			window.Alpine.initTree(document.body);
		}
	});
</script>
