---
import { Icon } from "astro-icon/components";
---

<div x-data="themeToggle()" x-init="init()">
	<button
		@click="toggle()"
		type="button"
		class="theme-toggle p-2.5 rounded-lg transition-all duration-200 hover:bg-tertiary text-secondary hover:text-primary focus:outline-none focus-visible:ring-2 ring-accent"
		:aria-label="isDark ? 'Switch to light mode' : 'Switch to dark mode'"
		:title="isDark ? 'Switch to light mode' : 'Switch to dark mode'"
	>
		<span x-show="!isDark" x-cloak>
			<Icon name="lucide:moon" class="size-5" aria-hidden="true" />
		</span>
		<span x-show="isDark" x-cloak>
			<Icon name="lucide:sun" class="size-5" aria-hidden="true" />
		</span>
	</button>
</div>

<style>
	.theme-toggle:focus-visible {
		--tw-ring-offset-width: 2px;
		--tw-ring-offset-color: var(--color-bg-primary);
	}
</style>

<script>
	document.addEventListener("alpine:init", () => {
		// @ts-ignore
		window.Alpine.data("themeToggle", () => ({
			isDark: false,

			init() {
				const stored = localStorage.getItem("theme");
				if (stored) {
					this.isDark = stored === "dark";
				} else {
					this.isDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
				}
				this.applyTheme();

				window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change", (e) => {
					if (!localStorage.getItem("theme")) {
						this.isDark = e.matches;
						this.applyTheme();
					}
				});
			},

			toggle() {
				this.isDark = !this.isDark;
				localStorage.setItem("theme", this.isDark ? "dark" : "light");
				this.applyTheme();
			},

			applyTheme() {
				document.documentElement.classList.toggle("dark", this.isDark);
			},
		}));
	});
</script>
